From 83a45bd7fb2141013c912f5708e80a2fd86c4779 Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Sat, 8 Mar 2025 21:44:34 +0800
Subject: [PATCH] ap8220 fix vi

---
 .../arm64/boot/dts/qcom/ipq8071-ap8220.dts    | 181 ++----------------
 .../arm64/boot/dts/qcom/ipq8071-edgecore.dtsi | 181 ++++++++++++++++++
 .../ipq807x/base-files/etc/board.d/02_network |   5 +-
 .../etc/hotplug.d/ieee80211/11_fix_wifi_mac   |   6 +-
 .../base-files/lib/upgrade/platform.sh        |   7 +-
 5 files changed, 204 insertions(+), 176 deletions(-)
 create mode 100644 target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-edgecore.dtsi

diff --git a/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-ap8220.dts b/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-ap8220.dts
index f49e377002..a62b3acf73 100644
--- a/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-ap8220.dts
+++ b/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-ap8220.dts
@@ -2,46 +2,16 @@
 
 /dts-v1/;
 
-#include "ipq8074.dtsi"
-#include "ipq8074-ac-cpu.dtsi"
-#include "ipq8074-ess.dtsi"
-#include "ipq8074-nss.dtsi"
-#include <dt-bindings/gpio/gpio.h>
-#include <dt-bindings/input/input.h>
+#include "ipq8071-edgecore.dtsi"
 
 / {
 	model = "Aliyun AP8220";
 	compatible = "aliyun,ap8220", "qcom,ipq8074";
 
-	aliases {
-		serial0 = &blsp1_uart5;
-		led-boot = &led_power;
-		led-failsafe = &led_power;
-		led-running = &led_power;
-		led-upgrade = &led_power;
-	};
-
-	chosen {
-		stdout-path = "serial0:115200n8";
-		bootargs-append = " root=/dev/ubiblock0_1";
-	};
-
-	keys {
-		compatible = "gpio-keys";
-		pinctrl-0 = <&button_pins>;
-		pinctrl-names = "default";
-
-		reset {
-			label = "reset";
-			linux,code = <KEY_RESTART>;
-			gpios = <&tlmm 66 GPIO_ACTIVE_LOW>;
-		};
-	};
-
 	leds {
 		compatible = "gpio-leds";
 
-		led_power: power {
+		led_pw: power {
 			label = "green:power";
 			gpios = <&tlmm 46 GPIO_ACTIVE_HIGH>;
 		};
@@ -63,31 +33,14 @@
 			gpios = <&tlmm 50 GPIO_ACTIVE_HIGH>;
 		};
 	};
-};
 
-&tlmm {
-	mdio_pins: mdio-pins {
-		mdc {
-			pins = "gpio68";
-			function = "mdc";
-			drive-strength = <8>;
-			bias-pull-up;
-		};
+	gpio-export {
+		compatible = "gpio-export";
 
-		mdio {
-			pins = "gpio69";
-			function = "mdio";
-			drive-strength = <8>;
-			bias-pull-up;
-		};
-	};
-
-	button_pins: button-pins {
-		mux {
-			pins = "gpio66";
-			function = "gpio";
-			drive-strength = <8>;
-			bias-pull-up;
+		ble-power {
+			gpio-export,name = "ble_power";
+			gpio-export,output = <1>;
+			gpios = <&tlmm 54 GPIO_ACTIVE_HIGH>;
 		};
 	};
 };
@@ -95,6 +48,10 @@
 &blsp1_spi1 {
 	status = "okay";
 
+	pinctrl-0 = <&spi_0_pins>;
+	pinctrl-names = "default";
+	cs-select = <0>;
+
 	flash@0 {
 		compatible = "jedec,spi-nor";
 		#address-cells = <1>;
@@ -109,44 +66,37 @@
 
 			partition@0 {
 				label = "0:sbl1";
-				reg = <0x0 0x50000>;
-				read-only;
+				reg = <0x00 0x50000>;
 			};
 
 			partition@50000 {
 				label = "0:mibib";
 				reg = <0x50000 0x10000>;
-				read-only;
 			};
 
 			partition@60000 {
 				label = "0:qsee";
 				reg = <0x60000 0x180000>;
-				read-only;
 			};
 
 			partition@1e0000 {
 				label = "0:devcfg";
 				reg = <0x1e0000 0x10000>;
-				read-only;
 			};
 
 			partition@1f0000 {
 				label = "0:apdp";
 				reg = <0x1f0000 0x10000>;
-				read-only;
 			};
 
 			partition@200000 {
 				label = "0:rpm";
 				reg = <0x200000 0x40000>;
-				read-only;
 			};
 
 			partition@240000 {
 				label = "0:cdt";
 				reg = <0x240000 0x10000>;
-				read-only;
 			};
 
 			partition@250000 {
@@ -157,25 +107,21 @@
 			partition@260000 {
 				label = "0:appsbl";
 				reg = <0x260000 0xa0000>;
-				read-only;
 			};
 
 			partition@300000 {
 				label = "0:art";
 				reg = <0x300000 0x40000>;
-				read-only;
 			};
 
 			partition@340000 {
 				label = "0:ethphyfw";
 				reg = <0x340000 0x80000>;
-				read-only;
 			};
 
 			partition@3c0000 {
 				label = "product_info";
 				reg = <0x3c0000 0x10000>;
-				read-only;
 			};
 
 			partition@3d0000 {
@@ -186,119 +132,24 @@
 			partition@3f0000 {
 				label = "priv_data1";
 				reg = <0x3f0000 0x10000>;
-				read-only;
 			};
 		};
 	};
 };
 
-&blsp1_uart5 {
-	status = "okay";
-};
-
-&cryptobam {
-	status = "okay";
-};
-
-&crypto {
-	status = "okay";
-};
-
-&prng {
-	status = "okay";
-};
-
-&qpic_bam {
-	status = "okay";
-};
-
-&qusb_phy_0 {
-	status = "okay";
-};
-
-&ssphy_0 {
-	status = "okay";
-};
-
-&usb_0 {
-	status = "okay";
-};
-
 &qpic_nand {
 	status = "okay";
 
-	partitions {
-		status = "disabled";
-	};
-
 	nand@0 {
 		reg = <0>;
+		#address-cells = <1>;
+		#size-cells = <1>;
 		nand-ecc-strength = <4>;
 		nand-ecc-step-size = <512>;
 		nand-bus-width = <8>;
-
-		partitions {
-			compatible = "fixed-partitions";
-			#address-cells = <1>;
-			#size-cells = <1>;
-
-			partition@0 {
-				label = "rootfs";
-				reg = <0x0000000 0x8000000>;
-			};
-		};
-	};
-};
-
-&mdio {
-	status = "okay";
-
-	pinctrl-0 = <&mdio_pins>;
-	pinctrl-names = "default";
-
-	qca8081_24: ethernet-phy@24 {
-		compatible = "ethernet-phy-id004d.d101";
-		reg = <24>;
-		reset-gpios = <&tlmm 33 GPIO_ACTIVE_LOW>;
-	};
-
-	qca8081_28: ethernet-phy@28 {
-		compatible = "ethernet-phy-id004d.d101";
-		reg = <28>;
-		reset-gpios = <&tlmm 44 GPIO_ACTIVE_LOW>;
-	};
-};
-
-&switch {
-	status = "okay";
-
-	switch_cpu_bmp = <0x1>;  /* cpu port bitmap */
-	switch_lan_bmp = <0x20>; /* lan port bitmap */
-	switch_wan_bmp = <0x40>; /* wan port bitmap */
-	switch_mac_mode = <0xff>; /* mac mode for uniphy instance0*/
-	switch_mac_mode1 = <0xf>; /* mac mode for uniphy instance1*/
-	switch_mac_mode2 = <0xf>; /* mac mode for uniphy instance2*/
-	bm_tick_mode = <0>; /* bm tick mode */
-	tm_tick_mode = <0>; /* tm tick mode */
-
-	qcom,port_phyinfo {
-		port@5 {
-			port_id = <5>;
-			phy_address = <24>;
-			port_mac_sel = "QGMAC_PORT";
-		};
-		port@6 {
-			port_id = <6>;
-			phy_address = <28>;
-			port_mac_sel = "QGMAC_PORT";
-		};
 	};
 };
 
-&edma {
-	status = "okay";
-};
-
 &dp5 {
 	status = "okay";
 	phy-handle = <&qca8081_24>;
@@ -313,6 +164,6 @@
 
 &wifi {
 	status = "okay";
-
+	qcom,ath11k-fw-memory-mode = <1>;
 	qcom,ath11k-calibration-variant = "Aliyun-AP8220";
 };
diff --git a/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-edgecore.dtsi b/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-edgecore.dtsi
new file mode 100644
index 0000000000..dc076f0de0
--- /dev/null
+++ b/target/linux/qualcommax/files/arch/arm64/boot/dts/qcom/ipq8071-edgecore.dtsi
@@ -0,0 +1,181 @@
+// SPDX-License-Identifier: GPL-2.0-or-later OR MIT
+
+#include "ipq8074.dtsi"
+#include "ipq8074-ac-cpu.dtsi"
+#include "ipq8074-ess.dtsi"
+#include "ipq8074-nss.dtsi"
+
+#include <dt-bindings/gpio/gpio.h>
+#include <dt-bindings/input/input.h>
+#include <dt-bindings/leds/common.h>
+
+/ {
+	aliases {
+		serial0 = &blsp1_uart5;
+		serial1 = &blsp1_uart3;
+
+		led-boot = &led_pw;
+		led-failsafe = &led_pw;
+		led-running = &led_pw;
+		led-upgrade = &led_pw;
+
+		ethernet4 = &dp5;
+		ethernet5 = &dp6;
+
+		label-mac-device = &dp6;
+	};
+
+	chosen {
+		stdout-path = "serial0:115200n8";
+		bootargs-append = " root=/dev/ubiblock0_1";
+	};
+
+	keys {
+		compatible = "gpio-keys";
+
+		reset {
+			label = "reset";
+			linux,code = <KEY_RESTART>;
+			gpios = <&tlmm 66 GPIO_ACTIVE_LOW>;
+		};
+	};
+};
+
+&tlmm {
+	mdio_pins: mdio-pins {
+		mdc {
+			pins = "gpio68";
+			function = "mdc";
+			drive-strength = <8>;
+			bias-pull-up;
+		};
+
+		mdio {
+			pins = "gpio69";
+			function = "mdio";
+			drive-strength = <8>;
+			bias-pull-up;
+		};
+	};
+
+	usb_mux_sel_pins: usb-mux-sel-pins {
+		mux {
+			pins = "gpio27";
+			function = "gpio";
+			drive-strength = <8>;
+			bias-pull-down;
+		};
+	};
+};
+
+&mdio {
+	status = "okay";
+
+	pinctrl-0 = <&mdio_pins>;
+	pinctrl-names = "default";
+
+	qca8081_24: ethernet-phy@24 {
+		compatible = "ethernet-phy-id004d.d101";
+		reg = <24>;
+		reset-deassert-us = <10000>;
+		reset-gpios = <&tlmm 33 GPIO_ACTIVE_LOW>;
+	};
+
+	qca8081_28: ethernet-phy@28 {
+		compatible = "ethernet-phy-id004d.d101";
+		reg = <28>;
+		reset-deassert-us = <10000>;
+		reset-gpios = <&tlmm 44 GPIO_ACTIVE_LOW>;
+	};
+};
+
+&switch {
+	status = "okay";
+
+	switch_lan_bmp = <ESS_PORT5>;
+	switch_wan_bmp = <ESS_PORT6>;
+	switch_mac_mode1 = <MAC_MODE_SGMII_PLUS>;
+	switch_mac_mode2 = <MAC_MODE_SGMII_PLUS>;
+
+	qcom,port_phyinfo {
+		port@5 {
+			port_id = <5>;
+			phy_address = <24>;
+			port_mac_sel = "QGMAC_PORT";
+		};
+
+		port@6 {
+			port_id = <6>;
+			phy_address = <28>;
+			port_mac_sel = "QGMAC_PORT";
+		};
+	};
+};
+
+&edma {
+	status = "okay";
+};
+
+&blsp1_i2c2 {
+	status = "okay";
+};
+
+&blsp1_spi1 {
+	status = "okay";
+};
+
+&blsp1_uart3 {
+	status = "okay";
+};
+
+&blsp1_uart5 {
+	status = "okay";
+};
+
+&crypto {
+	status = "okay";
+};
+
+&cryptobam {
+	status = "okay";
+};
+
+&pcie_qmp0 {
+	status = "okay";
+};
+
+&pcie_qmp1 {
+	status = "okay";
+};
+
+&prng {
+	status = "okay";
+};
+
+&qpic_bam {
+	status = "okay";
+};
+
+&qusb_phy_0 {
+	status = "okay";
+};
+
+&qusb_phy_1 {
+	status = "okay";
+};
+
+&ssphy_0 {
+	status = "okay";
+};
+
+&ssphy_1 {
+	status = "okay";
+};
+
+&usb_0 {
+	status = "okay";
+};
+
+&usb_1 {
+	status = "okay";
+};
diff --git a/target/linux/qualcommax/ipq807x/base-files/etc/board.d/02_network b/target/linux/qualcommax/ipq807x/base-files/etc/board.d/02_network
index 6fcb3d4eb1..773b95b2c4 100644
--- a/target/linux/qualcommax/ipq807x/base-files/etc/board.d/02_network
+++ b/target/linux/qualcommax/ipq807x/base-files/etc/board.d/02_network
@@ -83,8 +83,9 @@ ipq807x_setup_macs()
 
 	case "$board" in
 		aliyun,ap8220)
-			wan_mac=$(cat /dev/mtd12 | head -n 4 | grep "product.mac" | awk -F " " '{print $2}')
-			lan_mac=$(macaddr_add $wan_mac 1)
+		wan_mac=$(mtd_get_mac_text product_info 0x4b)
+		lan_mac=$(macaddr_add $wan_mac 1)
+		label_mac=$wan_mac
 		;;
 		linksys,mx4200v2|\
 		linksys,mx4300)
diff --git a/target/linux/qualcommax/ipq807x/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac b/target/linux/qualcommax/ipq807x/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
index 3cc120265f..22b1bf7d0e 100644
--- a/target/linux/qualcommax/ipq807x/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
+++ b/target/linux/qualcommax/ipq807x/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
@@ -11,9 +11,9 @@ board=$(board_name)
 
 case "$board" in
 	aliyun,ap8220)
-		wan_mac=$(cat /dev/mtd12 | head -n 4 | grep "product.mac" | awk -F " " '{print $2}')
-		[ "$PHYNBR" = "0" ] && macaddr_add $wan_mac 2 > /sys${DEVPATH}/macaddress
-		[ "$PHYNBR" = "1" ] && macaddr_add $wan_mac 3 > /sys${DEVPATH}/macaddress
+		label_mac=$(mtd_get_mac_text product_info 0x4b)
+		[ "$PHYNBR" = "0" ] && macaddr_add $label_mac 2 > /sys${DEVPATH}/macaddress
+		[ "$PHYNBR" = "1" ] && macaddr_add $label_mac 3 > /sys${DEVPATH}/macaddress
 		;;
 	arcadyan,aw1000)
 		[ "$PHYNBR" = "0" ] && macaddr_add $(get_mac_label) 1 > /sys${DEVPATH}/macaddress
diff --git a/target/linux/qualcommax/ipq807x/base-files/lib/upgrade/platform.sh b/target/linux/qualcommax/ipq807x/base-files/lib/upgrade/platform.sh
index d67306254c..ab12084870 100644
--- a/target/linux/qualcommax/ipq807x/base-files/lib/upgrade/platform.sh
+++ b/target/linux/qualcommax/ipq807x/base-files/lib/upgrade/platform.sh
@@ -128,12 +128,7 @@ platform_pre_upgrade() {
 platform_do_upgrade() {
 	case "$(board_name)" in
 	aliyun,ap8220)
-		active="$(fw_printenv -n active)"
-		if [ "$active" -eq "1" ]; then
-			CI_UBIPART="rootfs1"
-		else
-			CI_UBIPART="rootfs2"
-		fi
+		CI_UBIPART="rootfs"
 		nand_do_upgrade "$1"
 		;;
 	arcadyan,aw1000|\
-- 
2.34.1

