From d24c56e158efa9b4a889f88441813bb88c0ce2b5 Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Fri, 12 Apr 2024 19:43:04 +0800
Subject: [PATCH] fix ubootmod

---
 .../dts/mt7981b-nokia-ea0326gmp-ubootmod.dts  | 248 ++++++++++--------
 .../etc/hotplug.d/ieee80211/11_fix_wifi_mac   |   4 +
 2 files changed, 136 insertions(+), 116 deletions(-)

diff --git a/target/linux/mediatek/dts/mt7981b-nokia-ea0326gmp-ubootmod.dts b/target/linux/mediatek/dts/mt7981b-nokia-ea0326gmp-ubootmod.dts
index 3315663685..030cb6fe92 100644
--- a/target/linux/mediatek/dts/mt7981b-nokia-ea0326gmp-ubootmod.dts
+++ b/target/linux/mediatek/dts/mt7981b-nokia-ea0326gmp-ubootmod.dts
@@ -11,85 +11,135 @@
 	compatible = "nokia,ea0326gmp-ubootmod", "mediatek,mt7981";
 
 	aliases {
-		led-boot = &power_led;
-		led-running = &power_led;
-		led-failsafe = &power_led;
-		led-upgrade = &power_led;
+		serial0 = &uart0;
+
+		led-boot = &led_power;
+		led-failsafe = &led_power;
+		led-running = &led_power;
+		led-upgrade = &led_power;
+		label-mac-device = &gmac1;
 	};
 
 	chosen {
-		bootargs = "console=ttyS0,115200n1 loglevel=8 earlycon=uart8250,mmio32,0x11002000";
+		stdout-path = "serial0:115200n8";
 	};
 
-	memory@40000000 {
+	memory {
 		reg = <0 0x40000000 0 0x10000000>;
 	};
 
 	gpio-keys {
 		compatible = "gpio-keys";
 
-		button-reset {
+		reset {
 			label = "reset";
 			linux,code = <KEY_RESTART>;
 			gpios = <&pio 1 GPIO_ACTIVE_LOW>;
 		};
 
-		button-wps {
+		wps {
 			label = "wps";
 			linux,code = <KEY_WPS_BUTTON>;
-			gpios = <&pio 0 GPIO_ACTIVE_HIGH>;
+			gpios = <&pio 0 GPIO_ACTIVE_LOW>;
 		};
 	};
 
-	gpio-leds {
+	leds {
 		compatible = "gpio-leds";
 
-		power_led: led-0 {
+		led_power: power {
 			label = "green:power";
 			gpios = <&pio 4 GPIO_ACTIVE_LOW>;
 		};
 
-		led-1 {
+		wan_green {
 			label = "green:wan";
 			gpios = <&pio 5 GPIO_ACTIVE_LOW>;
 		};
 
-		led-2 {
+		wan_red {
 			label = "red:wan";
 			gpios = <&pio 6 GPIO_ACTIVE_LOW>;
 		};
 
-		led-3 {
+		lan {
 			label = "green:lan";
 			gpios = <&pio 7 GPIO_ACTIVE_LOW>;
 		};
 
-		led-4 {
-			label = "green:wlan";
+		wifi {
+			label = "green:wifi";
 			gpios = <&pio 8 GPIO_ACTIVE_LOW>;
+			linux,default-trigger = "phy1tpt";
 		};
 
-		led-5 {
+		wps {
 			label = "green:wps";
 			gpios = <&pio 9 GPIO_ACTIVE_LOW>;
 		};
 	};
+};
 
-	gsw: gsw@0 {
-		compatible = "mediatek,mt753x";
-		mediatek,ethsys = <&ethsys>;
-		#address-cells = <1>;
-		#size-cells = <0>;
+&eth {
+	status = "okay";
+
+	gmac0: mac@0 {
+		compatible = "mediatek,eth-mac";
+		reg = <0>;
+		phy-mode = "2500base-x";
+
+		nvmem-cells = <&macaddr_factory_28>;
+		nvmem-cell-names = "mac-address";
+
+		fixed-link {
+			speed = <2500>;
+			full-duplex;
+			pause;
+		};
 	};
 
-	nmbm_spim_nand {
-		compatible = "generic,nmbm";
+	gmac1: mac@1 {
+		compatible = "mediatek,eth-mac";
+		reg = <1>;
+		phy-mode = "gmii";
+		phy-handle = <&int_gbe_phy>;
+
+		nvmem-cells = <&macaddr_factory_28>;
+		nvmem-cell-names = "mac-address";
+		mac-address-increment = <3>;
+	};
+};
 
+&mdio_bus {
+	switch: switch@0 {
+		compatible = "mediatek,mt7531";
+		reg = <31>;
+		reset-gpios = <&pio 39 GPIO_ACTIVE_HIGH>;
+		interrupt-controller;
+		#interrupt-cells = <1>;
+		interrupt-parent = <&pio>;
+		interrupts = <38 IRQ_TYPE_LEVEL_HIGH>;
+	};
+};
+
+&spi0 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&spi0_flash_pins>;
+	status = "okay";
+
+	spi_nand@0 {
+		compatible = "spi-nand";
 		#address-cells = <1>;
 		#size-cells = <1>;
+		reg = <0>;
 
-		lower-mtd-device = <&spi_nand>;
-		forced-create;
+		spi-max-frequency = <52000000>;
+		spi-tx-bus-width = <4>;
+		spi-rx-bus-width = <4>;
+
+		mediatek,nmbm;
+		mediatek,bmt-max-ratio = <1>;
+		mediatek,bmt-max-reserved-blocks = <64>;
 
 		partitions {
 			compatible = "fixed-partitions";
@@ -98,132 +148,79 @@
 
 			partition@0 {
 				label = "BL2";
-				reg = <0x0 0x100000>;
+				reg = <0x0000000 0x0100000>;
+				read-only;
 			};
 
 			partition@100000 {
 				label = "u-boot-env";
-				reg = <0x100000 0x80000>;
+				reg = <0x0100000 0x0080000>;
 			};
 
-			partition@180000 {
+			factory: partition@180000 {
 				label = "Factory";
-				reg = <0x180000 0x200000>;
+				reg = <0x0180000 0x0200000>;
+				read-only;
 			};
 
 			partition@380000 {
 				label = "FIP";
-				reg = <0x380000 0x200000>;
+				reg = <0x0380000 0x0200000>;
+				read-only;
 			};
 
 			partition@580000 {
 				label = "Config";
-				reg = <0x580000 0x200000>;
+				reg = <0x0580000 0x0200000>;
+				read-only;
 			};
 
 			partition@780000 {
 				label = "Config2";
-				reg = <0x780000 0x200000>;
+				reg = <0x0780000 0x0200000>;
+				read-only;
 			};
 
 			partition@980000 {
 				label = "ubi";
 				reg = <0x980000 0x6e00000>;
 			};
-
-			/* Leave last 8.5 MiB for NMBM bad block table */
 		};
 	};
 };
 
-&eth {
-	status = "okay";
-
-	gmac0: mac@0 {
-		compatible = "mediatek,eth-mac";
-		reg = <0>;
-		phy-mode = "2500base-x";
-
-		fixed-link {
-			speed = <2500>;
-			full-duplex;
-			pause;
-		};
-	};
-
-	gmac1: mac@1 {
-		compatible = "mediatek,eth-mac";
-		reg = <1>;
-		phy-mode = "gmii";
-		phy-handle = <&phy0>;
-	};
-
-	mdio: mdio-bus {
+&switch {
+	ports {
 		#address-cells = <1>;
 		#size-cells = <0>;
 
-		phy0: ethernet-phy@0 {
-			compatible = "ethernet-phy-id03a2.9461";
-			reg = <0>;
-			phy-mode = "gmii";
-			nvmem-cells = <&phy_calibration>;
-			nvmem-cell-names = "phy-cal-data";
+		port@1 {
+			reg = <1>;
+			label = "lan1";
 		};
-	};
-};
-
-&gsw {
-	mediatek,mdio = <&mdio>;
-	mediatek,mdio_master_pinmux = <0>;
-	reset-gpios = <&pio 39 0>;
-	interrupt-parent = <&pio>;
-	interrupts = <38 IRQ_TYPE_LEVEL_HIGH>;
-	status = "okay";
 
-	port6: port@6 {
-		compatible = "mediatek,mt753x-port";
-		mediatek,ssc-on;
-		reg = <6>;
-		phy-mode = "sgmii";
-
-		fixed-link {
-			speed = <2500>;
-			full-duplex;
+		port@2 {
+			reg = <2>;
+			label = "lan2";
 		};
-	};
-};
 
-&hnat {
-        mtketh-wan = "eth1";
-        mtketh-lan = "eth0";
-        mtketh-max-gmac = <2>;
-        status = "okay";
-};
-
-&spi0 {
-	pinctrl-names = "default";
-	pinctrl-0 = <&spi0_flash_pins>;
-	status = "okay";
-
-	spi_nand: flash@0 {
-		#address-cells = <1>;
-		#size-cells = <1>;
-		compatible = "spi-nand";
-		reg = <0>;
-		spi-max-frequency = <52000000>;
+		port@3 {
+			reg = <3>;
+			label = "lan3";
+		};
 
-		spi-cal-enable;
-		spi-cal-mode = "read-data";
-		spi-cal-datalen = <7>;
-		spi-cal-data = /bits/ 8 <0x53 0x50 0x49 0x4E 0x41 0x4E 0x44>;
-		spi-cal-addrlen = <5>;
-		spi-cal-addr = /bits/ 32 <0x0 0x0 0x0 0x0 0x0>;
+		port@6 {
+			reg = <6>;
+			label = "cpu";
+			ethernet = <&gmac0>;
+			phy-mode = "2500base-x";
 
-		spi-tx-bus-width = <4>;
-		spi-rx-bus-width = <4>;
-		mediatek,nmbm;
-		mediatek,bmt-max-ratio = <1>;
-		mediatek,bmt-max-reserved-blocks = <64>;
+			fixed-link {
+				speed = <2500>;
+				full-duplex;
+				pause;
+			};
+		};
 	};
 };
 
@@ -237,13 +234,13 @@
 		conf-pu {
 			pins = "SPI0_CS", "SPI0_HOLD", "SPI0_WP";
 			drive-strength = <8>;
-			bias-pull-up = <103>;
+			mediatek,pull-up-adv = <0>; /* bias-disable */
 		};
 
 		conf-pd {
 			pins = "SPI0_CLK", "SPI0_MOSI", "SPI0_MISO";
 			drive-strength = <8>;
-			bias-pull-down = <103>;
+			mediatek,pull-up-adv = <0>; /* bias-disable */
 		};
 	};
 };
@@ -255,3 +252,22 @@
 &watchdog {
 	status = "okay";
 };
+
+&wifi {
+	status = "okay";
+
+	mediatek,mtd-eeprom = <&factory 0x0>;
+	nvmem-cells = <&macaddr_factory_28>;
+	nvmem-cell-names = "mac-address";
+	mac-address-increment = <1>;
+};
+
+&factory {
+	compatible = "nvmem-cells";
+	#address-cells = <1>;
+	#size-cells = <1>;
+
+	macaddr_factory_28: macaddr@28 {
+		reg = <0x28 0x6>;
+	};
+};
diff --git a/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac b/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
index 49cf3c3d41..7620d1cc67 100644
--- a/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
+++ b/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
@@ -51,6 +51,10 @@ case "$board" in
 		[ "$PHYNBR" = "0" ] && macaddr_add $addr 1 > /sys${DEVPATH}/macaddress
 		[ "$PHYNBR" = "1" ] && macaddr_add $addr 2 > /sys${DEVPATH}/macaddress
 		;;
+	nokia,ea0326gmp-ubootmod)
+		addr=$(mtd_get_mac_binary Factory 0x28)
+		[ "$PHYNBR" = "1" ] && macaddr_add $addr 2 > /sys${DEVPATH}/macaddress
+		;;
 	cmcc,rax3000m)
 		case "$(cmdline_get_var root)" in
 		/dev/mmc*)
-- 
2.34.1

