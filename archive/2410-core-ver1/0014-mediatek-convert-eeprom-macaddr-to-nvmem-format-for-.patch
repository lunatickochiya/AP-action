From 96414ee56f517c6ec6935fece8f6e58a5f374081 Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Fri, 8 Aug 2025 21:23:28 +0800
Subject: [PATCH 14/16] mediatek: convert eeprom/macaddr to nvmem format for
 cmcc rax3000m emmc

---
 .../mt7981b-cmcc-rax3000m-emmc-ubootmod.dts   | 68 ++++++++++++++++++-
 .../filogic/base-files/etc/board.d/02_network |  5 --
 .../etc/hotplug.d/firmware/11-mt76-caldata    |  1 -
 .../etc/hotplug.d/ieee80211/11_fix_wifi_mac   |  3 -
 4 files changed, 67 insertions(+), 10 deletions(-)

diff --git a/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-emmc-ubootmod.dts b/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-emmc-ubootmod.dts
index 60fd1ddbb6..ded5844f08 100644
--- a/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-emmc-ubootmod.dts
+++ b/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-emmc-ubootmod.dts
@@ -8,10 +8,20 @@
 	compatible = "cmcc,rax3000m-emmc-ubootmod", "mediatek,mt7981";
 
 	chosen {
-		bootargs-override = "root=PARTLABEL=rootfs rootwait rootfstype=squashfs,f2fs";
+		bootargs-override = "root=PARTLABEL=rootfs rootwait";
 	};
 };
 
+&gmac0 {
+	nvmem-cells = <&macaddr_factory_2a>;
+	nvmem-cell-names = "mac-address";
+};
+
+&gmac1 {
+	nvmem-cells = <&macaddr_factory_24>;
+	nvmem-cell-names = "mac-address";
+};
+
 &mmc0 {
 	#address-cells = <1>;
 	#size-cells = <0>;
@@ -25,6 +35,49 @@
 	pinctrl-1 = <&mmc0_pins_uhs>;
 	vmmc-supply = <&reg_3p3v>;
 	status = "okay";
+
+	card@0 {
+		compatible = "mmc-card";
+		reg = <0>;
+
+		block {
+			compatible = "block-device";
+
+			partitions {
+				block-partition-factory {
+					partname = "factory";
+
+					nvmem-layout {
+						compatible = "fixed-layout";
+						#address-cells = <1>;
+						#size-cells = <1>;
+
+						eeprom_factory_0: eeprom@0 {
+							reg = <0x0 0x1000>;
+						};
+
+						macaddr_factory_a: macaddr@a {
+									compatible = "mac-base";
+									reg = <0xa 0x6>;
+									#nvmem-cell-cells = <1>;
+								};
+
+						macaddr_factory_24: macaddr@24 {
+							compatible = "mac-base";
+							reg = <0x24 0x6>;
+							#nvmem-cell-cells = <1>;
+						};
+
+						macaddr_factory_2a: macaddr@2a {
+							compatible = "mac-base";
+							reg = <0x2a 0x6>;
+							#nvmem-cell-cells = <1>;
+						};
+					};
+				};
+			};
+		};
+	};
 };
 
 &pio {
@@ -42,3 +95,16 @@
 		};
 	};
 };
+
+&wifi {
+	#address-cells = <1>;
+	#size-cells = <0>;
+	nvmem-cells = <&eeprom_factory_0>;
+	nvmem-cell-names = "eeprom";
+
+	band@1 {
+				reg = <1>;
+				nvmem-cells = <&macaddr_factory_a 0>;
+				nvmem-cell-names = "mac-address";
+			};
+};
diff --git a/target/linux/mediatek/filogic/base-files/etc/board.d/02_network b/target/linux/mediatek/filogic/base-files/etc/board.d/02_network
index 99492583b9..1a149e2937 100644
--- a/target/linux/mediatek/filogic/base-files/etc/board.d/02_network
+++ b/target/linux/mediatek/filogic/base-files/etc/board.d/02_network
@@ -173,11 +173,6 @@ mediatek_setup_macs()
 	bananapi,bpi-r4)
 		wan_mac=$(macaddr_add $(cat /sys/class/net/eth0/address) 1)
 		;;
-	cmcc,rax3000m-emmc-ubootmod)
-		wan_mac=$(mmc_get_mac_binary factory 0x2a)
-		lan_mac=$(mmc_get_mac_binary factory 0x24)
-		label=$wan_mac
-		;;
 	h3c,magic-nx30-pro)
 		wan_mac=$(mtd_get_mac_ascii pdt_data_1 ethaddr)
 		lan_mac=$(macaddr_add "$wan_mac" 1)
diff --git a/target/linux/mediatek/filogic/base-files/etc/hotplug.d/firmware/11-mt76-caldata b/target/linux/mediatek/filogic/base-files/etc/hotplug.d/firmware/11-mt76-caldata
index ba69cdcf55..1d9db845db 100644
--- a/target/linux/mediatek/filogic/base-files/etc/hotplug.d/firmware/11-mt76-caldata
+++ b/target/linux/mediatek/filogic/base-files/etc/hotplug.d/firmware/11-mt76-caldata
@@ -13,7 +13,6 @@ case "$FIRMWARE" in
 		ln -sf /tmp/tp_data/MT7981_EEPROM.bin \
 			/lib/firmware/$FIRMWARE
 		;;
-	cmcc,rax3000m-emmc-ubootmod|\
 	ubnt,unifi-6-plus)
 		caldata_extract_mmc "factory" 0x0 0x1000
 		;;
diff --git a/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac b/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
index 309207e755..eaec7021a1 100644
--- a/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
+++ b/target/linux/mediatek/filogic/base-files/etc/hotplug.d/ieee80211/11_fix_wifi_mac
@@ -73,9 +73,6 @@ case "$board" in
 	cmcc,rax3000m-nand-ubootmod)
 		[ "$PHYNBR" = "1" ] && mtd_get_mac_binary Factory 0xa > /sys${DEVPATH}/macaddress
 		;;
-	cmcc,rax3000m-emmc-ubootmod)
-		[ "$PHYNBR" = "1" ] && mmc_get_mac_binary factory 0xa > /sys${DEVPATH}/macaddress
-		;;
 	nokia,ea0326gmp-ubootmod)
 		addr=$(mtd_get_mac_binary Factory 0x28)
 		[ "$PHYNBR" = "1" ] && macaddr_add $addr 2 > /sys${DEVPATH}/macaddress
-- 
2.43.0

